# Grafana-backup-via-API

## Описание
* Проект предоставляет два основных скрипта для работы с Grafana API:

* Бэкап - сохранение дашбордов, алертов, источников данных и контактных точек

* Восстановление - обновление конфигураций Grafana из бэкапов

## Функциональности

* Бэкап дашбордов Grafana

* Бэкап правил оповещений (alert rules)

* Бэкап источников данных (data sources)

* Бэкап контактных точек (contact points)

* Восстановление всех конфигураций

* Цветное логирование процесса

* Автоматическое создание директорий

## Требования
* Bash 4.0+

* cURL для HTTP запросов

* jq для работы с JSON

* Grafana 8.0+ (для некоторых функций требуется 9.0+)

* API ключ с правами администратора в Grafana

## Установка
### Клонирование репозитория
```bash
git clone https://github.com/Reconn-LLC/Grafana-backup-via-API.git
cd Grafana-backup-via-API
```
### Установка зависимостей

```bash
# Ubuntu/Debian
sudo apt update && sudo apt install jq curl git

# CentOS/RHEL
sudo yum install jq curl git-all
```



### Настройка прав доступа
```bash
chmod +x menu.sh
```

## Конфигурация

Перед началом работы Вам необходимо создать API-ключ для Grafana

### Создание API ключа

1. Войдите в Grafana и щелкните «Administration» в меню слева
2. «Users and Access» -> «Service Accounts»
3. Нажмите "Add service account", если у Вас нету служебной учётной записи, и создайте её
4. Выберите служебную учетную запись, к которой хотите добавить токен
5. Нажмите «Add service account token»
6. Введите имя токена.
7. Нажмите «Generate Token».

## Использование

> Перед началом работы убедитесь, что вы инициализировали рабочую директорию и подключили её к вашему удалённому репозиторию. Это необходимо для корректной выгрузки резервных копий Grafana.

При **первом запуске** программы вам будет предложено настроить файл конфигурации `.env`. Этот файл содержит ключевые параметры работы скрипта, такие как путь к директории резервного копирования, API-ключ и URL для Grafana.

Для запуска программы используйте команду:

```bash
./menu.sh
```

После запуска откроется интерактивное меню:

```text
=== MAIN MENU ===
1) Backup Data            3) Edit .env              5) Exit
2) Update Data            4) Show Current Settings
#? 
```

Описание пунктов меню:

1. **Backup Data** – Создание резервной копии данных.
   Программа сохранит текущие настройки и данные Grafana в локальную директорию, а затем (при подключении к удалённому репозиторию) выгружает их на сервер для безопасного хранения.
   В результате выполнения:
   * Создаются JSON файлы в указанных директориях
   * Сохраняются все текущие конфигурации
   * Выводится цветной статус выполнения

2. **Update Data** – Обновление данных в Grafana.
   Позволяет подтянуть актуальные данные или конфигурации, обеспечивая синхронизацию с последними изменениями и поддерживая резервные копии в актуальном состоянии. В результате выполнения:
   * Обновляются дашборды через API
   * Восстанавливаются правила оповещений
   * Обновляются источники данных
   * Восстанавливаются контактные точки

3. **Edit .env** – Редактирование файла конфигурации `.env`.
   Позволяет изменить ключевые параметры программы, такие как путь к директории резервного копирования, настройки подключения к репозиторию и другие переменные окружения, необходимые для корректной работы скрипта.

4. **Show Current Settings** – Просмотр текущих настроек.
   Отображает значения всех переменных окружения и конфигураций, чтобы вы могли проверить текущие настройки перед выполнением операций резервного копирования или обновления.

5. **Exit** – Выход из программы.
   Завершает работу скрипта и закрывает меню.

Структура файлов
```text
/srv/grf_bkp/
├── grafana-dashboards-backup/
│   ├──  dashboard_1.json
│   ├──  dashboard_2.json
│   ├──  dashboard_3.json
│   ...
├── grafana-alerts-backup/
│   └── alert_rules.json
├── grafana-data-sources-backup/
│   └── data_sources.json
└── grafana-contact-points-sources-backup/
    └── contact_points.json
```
## Устранение неполадок

### Ошибка аутентификации:

``` bash
# Проверить API ключ
curl -H "Authorization: Bearer $KEY" $HOST/api/dashboards/search
```

### Ошибка прав доступа:

```bash
# Проверить права на директории
ls -la /path/to/your/backup/dir
```
